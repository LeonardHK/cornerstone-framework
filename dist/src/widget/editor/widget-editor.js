/*
    Cornerstone Framework v0.9.1

    COPYRIGHT(C) 2012 BY SKTELECOM CO., LTD. ALL RIGHTS RESERVED.
    Released under the Apache License, Version 2.0
*/
!function(a,b,c){"function"==typeof define&&define.amd?define(["backbone","underscore","jquery"],function(d,e,f){return c(f,a,b),d.View.extend({render:function(){return this.$el.featuredEditor(this.options),this}})}):c(a.jQuery,a,b)}(window,document,function(a,b,c){"use strict";var d=function(b){var c=a.Deferred(),d=new FileReader;return d.onload=function(a){c.resolve(a.target.result)},d.onerror=c.reject,d.onprogress=c.notify,d.readAsDataURL(b),c.promise()};a.fn.cleanHtml=function(){var b=a(this).html();return b&&b.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},a.fn.wysiwyg=function(e){var f,g,h,i=this,j=function(){g.activeToolbarClass&&a(g.toolbarSelector).find(h).each(function(){var b=a(this).data(g.commandRole);c.queryCommandState(b)?a(this).addClass(g.activeToolbarClass):a(this).removeClass(g.activeToolbarClass)})},k=function(a,b){var d=a.split(" "),e=d.shift(),f=d.join(" ")+(b||"");c.execCommand(e,0,f),j()},l=function(b){a.each(b,function(a,b){i.keydown(a,function(a){i.attr("contenteditable")&&i.is(":visible")&&(a.preventDefault(),a.stopPropagation(),k(b))}).keyup(a,function(a){i.attr("contenteditable")&&i.is(":visible")&&(a.preventDefault(),a.stopPropagation())})})},m=function(){var a=b.getSelection();return a.getRangeAt&&a.rangeCount?a.getRangeAt(0):void 0},n=function(){f=m()},o=function(){var a=b.getSelection();if(f){try{a.removeAllRanges()}catch(d){c.body.createTextRange().select(),c.selection.empty()}a.addRange(f)}},p=function(b){i.focus(),a.each(b,function(b,c){/^image\//.test(c.type)?a.when(d(c)).done(function(a){k("insertimage",a)}).fail(function(a){g.fileUploadError("file-reader",a)}):g.fileUploadError("unsupported-file-type",c.type)})},q=function(a,b){o(),c.queryCommandSupported("hiliteColor")&&c.execCommand("hiliteColor",0,b||"transparent"),n(),a.data(g.selectionMarker,b)},r=function(b,c){b.find(h).click(function(){o(),i.focus(),k(a(this).data(c.commandRole)),n()}),b.find("[data-toggle=dropdown]").click(o),b.find("input[type=text][data-"+c.commandRole+"]").on("webkitspeechchange change",function(){var b=this.value;this.value="",o(),b&&(i.focus(),k(a(this).data(c.commandRole),b)),n()}).on("focus",function(){var b=a(this);b.data(c.selectionMarker)||(q(b,c.selectionColor),b.focus())}).on("blur",function(){var b=a(this);b.data(c.selectionMarker)&&q(b,!1)}),b.find("input[type=file][data-"+c.commandRole+"]").change(function(){o(),"file"===this.type&&this.files&&this.files.length>0&&p(this.files),n(),this.value=""})},s=function(){i.on("dragenter dragover",!1).on("drop",function(a){var b=a.originalEvent.dataTransfer;a.stopPropagation(),a.preventDefault(),b&&b.files&&b.files.length>0&&p(b.files)})};return g=a.extend({},a.fn.wysiwyg.defaults,e),h="a[data-"+g.commandRole+"],button[data-"+g.commandRole+"],input[type=button][data-"+g.commandRole+"]",l(g.hotKeys),g.dragAndDropImages&&s(),r(a(g.toolbarSelector),g),i.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){n(),j()}),a(b).bind("touchend",function(a){var b=i.is(a.target)||i.has(a.target).length>0,c=m(),d=c&&c.startContainer===c.endContainer&&c.startOffset===c.endOffset;(!d||b)&&(n(),j())}),this},a.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0},a.fn.featuredEditor=function(b){return this.each(function(){var d=a(this),e=d.closest(".widget-editor"),f=function(){var b=["Serif","Arial","Courier","Courier New","Helvetica","Lucida Grande","Lucida Sans","Tahoma","Times"],f=e.find("[title=Font]").siblings(".dropdown-menu");if(a.each(b,function(b,c){f.append(a('<li><a data-edit="fontName '+c+'" style="font-family:\''+c+"'\">"+c+"</a></li>"))}),e.find("a[title]").tooltip({container:"body"}),e.find(".dropdown-menu input").click(function(){return!1}).change(function(){a(this).parent(".dropdown-menu").siblings(".dropdown-toggle").dropdown("toggle")}).keydown("esc",function(){this.value="",a(this).change()}),e.find("[data-role=magic-overlay]").each(function(){var b=a(this),c=a(b.data("target"));b.css("opacity",0).css("position","absolute").offset(c.offset()).width(c.outerWidth()).height(c.outerHeight())}),"onwebkitspeechchange"in c.createElement("input")){var g=d.offset();e.find(".btn-editor-voice").css("position","absolute").offset({top:g.top,left:g.left+d.innerWidth()-35})}else e.find(".btn-editor-voice").hide()};f(),d.wysiwyg(b)})},a("[data-featured=editor]").each(function(){a(this).featuredEditor()})});