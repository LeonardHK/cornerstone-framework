/*
    Cornerstone Framework v0.9.1

    COPYRIGHT(C) 2012 BY SKTELECOM CO., LTD. ALL RIGHTS RESERVED.
    Released under the Apache License, Version 2.0
*/
!function(){"use strict";var a,b=this,c="featuredChart",d="ontouchstart"in window,e={shown:"shown.cs.chart",animationEnd:"animationEnd.cs.chart",complete:"complete.cs.chart"},f=!1,g=function(a,b){this.el=a,this.$el=$(a),this.options=b,nv.dev=!1,this.render(b)};if(g.prototype={afterRender:function(a,b,c){this.$el.data("currentChart",c),this.$el.data("currentChartControlsData",b.controlsData);var d=a.select(".nv-controlsWrap");d.attr("transform","translate(-55,"+this.util.getTranslateJson(d).y+")"),this.util.removeClip(a),this.util.applyBindEvent(a,b,c,this)},render:function(b){!navigator.userAgent.toLowerCase().match(/webkit/gi)&&b.chartType.match(/.*bar3d.*/gi)&&(b.chartType=b.chartType.replace("3d",""));var c=this,d=this.util.getTarget(d3.select(this.el),b);return d.$parent=this.$el,b.chartType.match(/.*bar3d.*/gi)?c[b.chartType+"Chart"](d,b):nv.addGraph(function(b,c,d){var g=d.color.length;a=b[d.chartType+"Chart"](c,d),a.tooltips(d.tooltips).color(function(a,b){return d.color[b%g]}),"line"===d.chartType&&f&&console.log(d),b.util.activeAxisLabel(c,d,a);var h=d.beforeRender(c,d,a);a="function"==typeof h?h:a,c.attr("width",d.width).attr("height",d.height).datum(d.data).transition().duration(500).each("end",function(){$(b.el).trigger(e.shown),f&&f&&console.log(e.shown),(d.chartType.match(/line/gi)||!d.chartType.match(/bar.*|horizontalBar.*/gi))&&($(b.el).trigger(e.complete),f&&f&&console.log(e.complete))}).call(a),"function"==typeof a.afterRender&&a.afterRender("render"),a.multibar&&a.multibar.dispatch.on("animated",function(a){$(b.el).trigger(e.animationEnd,{target:a.target,data:a.data}),f&&console.log(e.animationEnd)}),a.multibar&&a.multibar.dispatch.on("lastAnimated",function(){$(b.el).trigger(e.complete),f&&console.log(e.complete),c.$parent.hasClass("overlay")&&c.$parent.removeClass("overlay")}),b.afterRender(c,d,a)}(c,d,b)),this},barChart:function(b,c){var d=this;return a=nv.models.multiBarChart(),a.showLegend(c.showLegend).showControls(c.showControls).controlsData(c.controlsData),a.afterRender=function(a){var e=this;if(!c.showValues)return!1;if(b.select(".nv-showValuesWrap").remove(),e.multibar&&e.multibar.stacked())return b.select(".nv-showValuesWrap").remove(),$(d.el).off("animationEnd._barChart"),!1;var f=b.select(".nv-barsWrap .nv-groups"),g=f.append("svg:g").attr("class","nv-showValuesWrap");g.style({opacity:1});var h=function(a,b){var d=d3.select(b.target),e=g.append("svg:text").attr("class","nv-value"),f=parseInt(d.attr("x"))+parseInt(d.attr("width"))/2,h=d.attr("y")-2,i=d.attr("width"),j=d.attr("height");return e.attr("x")!=f||e.attr("y")!=h||e.attr("width")!=i||e.attr("height")!=j?e.attr({opacity:0,x:f,y:h,width:i,height:j,"text-anchor":"middle",transform:d.attr("transform")}).transition().attr({opacity:1}).text(d3.format(c.format)(d.data()[0].y)):e.attr({opacity:1}),a};return d.util.removeClip(b),$(d.el).off("animationEnd._barChart").on("animationEnd._barChart",h),a},a},stackedBarChart:function(a,b){b.controlsData.active="stacked";var c=this.barChart(a,b);return c.showControls(!1),c.stacked(!0),c},groupedBarChart:function(a,b){b.controlsData.active="grouped";var c=this.barChart(a,b);return c.showControls(!1),c},lineChart:function(b,c){return a=nv.models.lineChart().showLegend(c.showLegend)},pieChart:function(b,c){return a=nv.models.pieChart().showLegend(c.showLegend).tooltips(c.tooltips)},horizontalBarChart:function(b,c){return a=nv.models.multiBarHorizontalChart().showValues(c.showValues).showLegend(c.showLegend).showControls(c.showControls).valueFormat(d3.format(c.format)).tooltips(c.tooltips).controlsData(c.controlsData)},stackedHorizontalBarChart:function(a,b){b.controlsData.active="stacked";var c=this.horizontalBarChart(a,b);return c.showControls(!1),c.stacked(!0),c},groupedHorizontalBarChart:function(a,b){b.controlsData.active="grouped";var c=this.horizontalBarChart(a,b);return c.showControls(!1),c},linePlusBarChart:function(b,c){return a=nv.models.linePlusBarChart(),a.bars.forceY([0]),a.showLegend(c.showLegend),a.xAxis.showMaxMin(c.showMaxMin).tickFormat(d3.format(c.format)),a.y1Axis.tickFormat(d3.format(c.format)),a.y2Axis.tickFormat(d3.format(c.format)),a},lineFocusChart:function(b,c){var d=this;return a=nv.models.lineWithFocusChart(),a.xAxis.tickFormat(d3.format(c.format)),a.yAxis.tickFormat(d3.format(c.format)),a.y2Axis.tickFormat(d3.format(c.format)),a.showLegend(c.showLegend),a.afterRender=function(){function e(d){d=d?d:a.x2Axis.scale().domain();var e=d3.svg.brush(),f=a.lines;if(Math.abs(d[0]-d[1])<=1)return d;a.dispatch.brush({extent:d,brush:e});var g=b.select(".nv-focus .nv-linesWrap").datum(c.data.filter(function(a){return!a.disabled}).map(function(a){return{key:a.key,values:a.values.filter(function(a,b){return f.x()(a,b)>=d[0]&&f.x()(a,b)<=d[1]})}}));return g.transition().call(f),b.select(".nv-focus .nv-x.nv-axis").transition().call(a.xAxis),b.select(".nv-focus .nv-y.nv-axis").transition().call(a.yAxis),d}b.$parent.swipe();var f=a.x2Axis.scale().domain(),g=.1*f[1],h=[f[0],f[0]+g],i=function(a,b){var c,d,i=b.direction;return i.match(/left|right/gi)?("left"===i?(c=h[1],d=h[1]+g):"right"===i&&(c=h[0]-g,d=h[0]),c=f[0]>=c?f[0]:c,d=f[1]<=d?f[1]:d,d=c>d?c+g:d,h=[c,d],h=e(h),"undefined"==typeof h&&(h="left"===i?[f[1]-g,f[1]]:[f[0],f[0]+g]),a.preventDefault(),a.stopPropagation(),h):!1};b.$parent.off("swipe._chart").on("swipe._chart",i),d.util.removeClip(b)},a},bar3dChart:function(a,b){function c(a,b){b<a.length&&($(a[b].bar).css({height:a[b].height,"-webkit-transition":"all 0.8s ease-out"}),i=setTimeout(function(){b++,c(a,b),$(l.el).trigger(e.animationEnd),f&&f&&console.log(e.animationEnd),a.length===b&&($(l.el).trigger(e.complete),f&&f&&console.log(e.complete))},100))}function d(){f&&f&&console.log(e.shown),l.util.applyBindEvent3dChart(a,b),$.each(m,function(a){$(m[a].bar).stop().css({height:0,"-webkit-transition":"none"})}),k="rotateX("+w+"deg) rotateY("+x+"deg)",s.css({"-webkit-transition":"none","-webkit-transform":k}),clearTimeout(i),clearTimeout(j),j=setTimeout(function(){k="rotateX("+y+"deg) rotateY("+z+"deg)",s.css({"-webkit-transform":k,"-webkit-transition":"all 2.8s ease-out"}),c(m,0)},100)}var g,h,i,j,k,l=this,m=[],n=$('<div class="figure"></div>'),o=$('<div class="graph"></div>'),p=$('<div class="bars"></div>'),q=$(b.data),r=q.length,s=a,t=!0,u=0,v=0,w=15,x=25,y=-20,z=$.isNumeric(b.endYRotation)?b.endYRotation:-15,A=45,B=52,C=B*r,D={chartData:function(){var a=[];return q.each(function(){$(this.values).each(function(){a.push(d3.format(b.format)(this.y))})}),a},chartLegend:function(){var a=[];return q.each(function(){a.push(this.key)}),a},chartYMax:function(){var a=Math.max.apply(Math,this.chartData()),b=Math.pow(10,a.toString().replace(/\..*/gi,"").length-1);return Math.ceil(Math.max.apply(Math,this.chartData())/b)*b},yLegend:function(){for(var a=this.chartYMax(),c=[],d=5,e=0;d>e;e++)c.unshift(d3.format(b.format)(a*e/(d-1)));return c},xLegend:function(){var a=[],c=0;return q.each(function(){this.values;var d=this.values.length;d>c&&$(this.values).each(function(){a.push(d3.format(b.format)(this.x))}),c=d}),a},columnGroups:function(){var a=[];return q.each(function(c){a[c]=$.map(this.values,function(a){return d3.format(b.format)(a.y)})}),a=l.util.transpose(a)}};if(g=D.chartYMax(),h=D.columnGroups(),$.each(h,function(a){for(var b=$('<div class="bar-group"></div>').css({width:C}),c=0,d=h[a].length;d>c;c++){var e={};e.label=this[c],e.height=Math.floor(100*(e.label/g))+"%",e.bar=$('<div class="bar fig'+c+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div><span>'+e.label+"</span></div>").css({left:B*c+"px"}).appendTo(b),m.push(e)}b.appendTo(p)}),b.showLegend){var E=D.chartLegend(),F=$('<ul class="legend"></ul>');$.each(E,function(a){$('<li><span class="icon fig'+a+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div></span>'+this+"</li>").appendTo(F)}),F.appendTo(n)}var G=D.xLegend(),H=G.length*C+30*G.length,I=$('<ul class="x-axis"></ul>').css({width:H});$.each(G,function(){$("<li><span>"+this+"</span></li>").css({width:C}).appendTo(I)}),I.appendTo(o);var J=D.yLegend(),K=$('<ul class="y-axis"></ul>').css({width:H});if($.each(J,function(){$("<li><span>"+this+"</span></li>").appendTo(K)}),K.appendTo(o),p.css({width:H}).appendTo(o),a.css({width:H}),a.$parent.css({width:H}),o.appendTo(n),n.appendTo(s),$(document).keydown(function(){if(t){switch(event.keyCode){case 37:"bar3d"===b.chartType?v-=A:u-=A;break;case 38:"bar3d"===b.chartType?u+=A:v-=A;break;case 39:"bar3d"===b.chartType?v+=A:u+=A;break;case 40:"bar3d"===b.chartType?u-=A:v+=A}k="rotateX("+u+"deg) rotateY("+v+"deg)",s.css("-webkit-transform",k)}}),$(l.el).trigger(e.shown),d(),"function"==typeof $.fn.swipe){a.$parent.swipe();var L=function(a,c){switch(c.direction){case"left":"bar3d"===b.chartType?v-=A:u-=A;break;case"up":"bar3d"===b.chartType?u+=A:v-=A;break;case"right":"bar3d"===b.chartType?v+=A:u+=A;break;case"down":"bar3d"===b.chartType?u-=A:v+=A}k="rotateX("+u+"deg) rotateY("+v+"deg)",s.css("-webkit-transform",k),a.preventDefault(),a.stopPropagation()};a.$parent.off("swipe._chart").on("swipe._chart",L)}"function"==typeof $.fn.doubletap&&a.$parent.doubletap(function(){d()})},horizontalBar3dChart:function(a,b){var c=a.closest(".widget-chart3d");!c.hasClass("widget-chart3d-hbar")&&c.addClass("widget-chart3d-hbar"),b.endYRotation=0,this.bar3dChart(a,b)},util:{transpose:function(a){var b=a.length?a.length:0,c=a[0]instanceof Array?a[0].length:0;if(0===c||0===b)return[];var d,e,f=[];for(d=0;c>d;d++)for(f[d]=[],e=0;b>e;e++)f[d][e]=a[e][d];return f},removeClip:function(a){var b=a.selectAll(".nv-groups");$(b[0]).each(function(){$(this).parent().removeAttr("clip-path")})},getTranslateJson:function(a){try{return JSON.parse(a.attr("transform").replace("translate(",'{"x":').replace(",",',"y":').replace(")","}"))}catch(b){return{x:0,y:0}}},getTarget:function(a,b){var c;return b.chartType.match(/bar3d.*/gi)?(0===$(a[0][0]).find(".bar3d").length&&$(a[0][0]).html($("<div/>",{"class":"wrapper"}).html($("<div/>",{"class":"bar3d"}))),a=$(a[0][0]).find(".bar3d"),!a.hasClass("chart")&&a.addClass("chart"),c=a.closest(".widget-chart"),!c.hasClass("widget-chart3d")&&c.addClass("widget-chart3d")):a=a.select("svg").length>0&&null===a.select("svg")[0][0]?a.append("svg:svg"):a.select("svg"),a},activeAxisLabel:function(a,b,c){var d=0,e=0;"bar"===b.chartType?(c.xAxis.tickFormat(d3.format(b.format)).axisLabel(b.xAxisLabel),c.yAxis.tickFormat(d3.format(b.format)).axisLabel(b.yAxisLabel),d=$.trim(b.yAxisLabel).length>0?75:50,c.margin({top:30,right:10,bottom:50,left:d})):"horizontalBar"===b.chartType?(c.xAxis.tickFormat(d3.format(b.format)).axisLabel(b.yAxisLabel),c.yAxis.tickFormat(d3.format(b.format)).axisLabel(b.xAxisLabel),d=$.trim(b.yAxisLabel).length>0?75:50,c.margin({top:30,right:10,bottom:50,left:d})):"linePlusBar"===b.chartType?(c.xAxis.tickFormat(d3.format(b.format)).axisLabel(b.xAxisLabel),c.y1Axis.tickFormat(d3.format(b.format)).axisLabel(b.yAxisLabel),c.y2Axis.tickFormat(d3.format(b.format)).axisLabel(b.y2AxisLabel),d=$.trim(b.yAxisLabel).length>0?75:35,e=$.trim(b.y2AxisLabel).length>0?85:50,c.margin({top:30,right:e,bottom:50,left:d})):"lineFocus"===b.chartType||"line"===b.chartType?(c.xAxis.tickFormat(d3.format(b.format)).axisLabel(b.xAxisLabel),c.yAxis.tickFormat(d3.format(b.format)).axisLabel(b.yAxisLabel),d=$.trim(b.yAxisLabel).length>0?75:50,c.margin({top:30,right:30,bottom:50,left:d})):"pie"!==b.chartType&&(c.xAxis.tickFormat(d3.format(b.format)).axisLabel(b.xAxisLabel),c.yAxis.tickFormat(d3.format(b.format)).axisLabel(b.yAxisLabel))},applyBindEvent:function(a,b,c,e){var g=function(d){f&&console.log("상태:",JSON.stringify(d)),!a.$parent.hasClass("overlay")&&a.$parent.addClass("overlay"),setTimeout(function(){"function"==typeof c.afterRender&&c.afterRender("stateChange"),"function"!=typeof c.multibar&&a.$parent.hasClass("overlay")&&a.$parent.removeClass("overlay"),e.afterRender(a,b,c)},10)},h=function(d){c.update(),setTimeout(function(){"function"==typeof c.afterRender&&c.afterRender("resize"),e.afterRender(a,b,c)},10),d.preventDefault(),d.stopPropagation()};c.dispatch.stateChange&&c.dispatch.on("stateChange",g),d?window.onorientationchange=function(a){!b.autoResize||h(a)}:$(window).on("resizeEnd._chart",function(a){!b.autoResize||h(a)}),$(window).on("resize._chart",function(a){a.target.resizeTO&&clearTimeout(a.target.resizeTO),a.target.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},500)})},applyBindEvent3dChart:function(a,b){var c=function(){var c,d=a.closest(".widget-chart3d");c="bar3d"===b.chartType?window.innerWidth/a.width():window.innerWidth/(a.height()+a.find(".x-axis").height()),d.removeAttr("style"),c=c>1?a.$parent.parent().width()/a.width():c,d.find(".wrapper").css({webkitPerspective:20*a.width()}),1>c?"bar3d"===b.chartType?d.css({width:a.width(),height:a.height()+a.find(".x-axis").height(),marginLeft:1.2*.1*-a.width()*c,marginBottom:1.2*-a.height()*(1-c),webkitTransform:"scale("+c+")"}):d.css({width:1.1*a.height(),height:a.width(),marginBottom:-a.width()*(1-c),webkitTransform:"scale("+c+")"}):"bar3d"===b.chartType?d.css({height:a.height()+a.find(".x-axis").height(),marginLeft:.1*-a.width()}):d.css({height:a.width()+a.find(".x-axis").height()})};c(),d?window.onorientationchange=function(){!b.autoResize||c()}:$(window).on("resizeEnd._chart",function(){!b.autoResize||c()}),$(window).on("resize._chart",function(a){a.target.resizeTO&&clearTimeout(a.target.resizeTO),a.target.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},500)})}}},$.fn.featuredChart=function(a){var b={chartType:"bar",xAxisLabel:"",yAxisLabel:"",y2AxisLabel:"",format:".1f",data:[],showMaxMin:!0,showValues:!0,showControls:!0,showLegend:!0,tooltips:!0,color:["#2c3e50","#e74c3c","#3498db","#f5a503","#7c569f","#75483e","#bf64a3","#6b6b6b"],controlsData:{active:"grouped",groupedName:"그룹",stackedName:"스택"},autoResize:!0,beforeRender:function(a,b,c){return c}};return this.each(function(){var d=$(this),e=d.data(c);e?(a=$.extend(!0,b,a),d.html(""),e.options=a,e.render(e.options)):(a=$.extend(!0,b,a),a.data.length||f&&console.log("데이터가 없습니다"),e=new g(this,a),d.data(c,e))})},$.fn.featuredChart.Constructor=g,b.Cornerstone=b.Cornerstone||{},b.Cornerstone.Widget=b.Cornerstone.Widget||{},b.Cornerstone.Widget.chart=b.Cornerstone.Widget.chart||{},b.Cornerstone.Widget.chart.activeDataApi=function(a){a=a&&a.length?a.find("[data-featured=chart]"):$("[data-featured=chart]"),a.each(function(){var a=this,b=$(this).data("chartBind");b&&$.getJSON(b).success(function(b){$(a)[c]({chartType:$(a).data("chartType"),format:$(a).data("chartFormat"),data:b})})})},$(function(){b.Cornerstone.Widget.chart.activeDataApi()}),"function"==typeof b.define&&b.define.amd){var h=b.define;h(["jquery","underscore","backbone","d3","nv","widget-touch"],function(a,b,c){return c.View.extend({model:new c.Model,initialize:function(){this.model.on("change",this.render,this)},render:function(){var b=[];return a.each(this.model.toJSON(),function(a,c){b.push(c)}),this.options.chartOptions.data=b,this.$el.featuredChart(this.options.chartOptions),this}})})}}.call(this);