/*
 *  Project: SKT HTML5 Framework
 *  CodeName : CornerStone
 *  FileName : featured-chart.js
 *  Description: D3 chart를 jQuery 플러그인 형태로 사용 할 수 있고, 반응형 웹에 맞는 화면을 보여주도록 구현함.
 *  Author: 김우섭
 *  License :
 */(function(){"use strict";var e=this,t="featuredChart",n={chartType:"bar",lineType:"basis",xAxisLabel:null,yAxisLabel:null,width:960,height:600,margin:[0,0,0,0],padding:[0,0,0,0],data:{},animate:!1,showControls:!1,showLegend:!1,tooltips:!1,control:{active:"grouped",groupedName:"그룹",stackedName:"스택"},autoResize:!0},r,i,s=function(e,t){this.el=e;this.$el=$(e);nv.dev=!1;this.render(t)};s.prototype={beforeRender:function(e,t){this.isNotFirst&&(t.control=$.extend({},t.control,{active:$(this.el).find(".nv-controlsWrap .nv-series:not(.disabled)").data("control")}))},afterRender:function(e,t){this.util.customControl(e,t);this.$el.data("currentChart",r);this.$el.data("currentChartControl",t.control);this.util.applyBindEvent(e,t,r,this.$el);this.util.removeLegendStyleAttr(e);e.select(".nv-controlsWrap").style("display",[t.showControls?"block":"none"]);e.select(".nv-legendWrap").style("display",[t.showLegend?"block":"none"]);this.isNotFirst=!0},render:function(e){var t=this.util.getTarget(d3.select(this.el));this.beforeRender(t,e);r=this[e.chartType+"Chart"](t,e);this.afterRender(t,e)},barChart:function(e,t){var n=this,r=nv.models.multiBarChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);r.stacked(t.control.active!=="grouped");r.yAxis.tickFormat(d3.format(".0f"));e.datum(t.data).transition().duration(500).each("end",function(){$(e).trigger("shown")}).call(r);return r},stackedBarChart:function(e,t){i=this;nv.addGraph(function(){var n=nv.models.multiBarChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);n.stacked(!0);e.datum(t.data).transition().duration(500).call(n);i.util.applyBindEvent(e,t,n,i.$el);i.util.removeLegendStyleAttr(e);return n})},groupedBarChart:function(e,t){i=this;nv.addGraph(function(){var n=nv.models.multiBarChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);n.stacked(!1);e.datum(t.data).transition().duration(500).call(n);i.util.applyBindEvent(e,t,n,i.$el);i.util.removeLegendStyleAttr(e);return n})},lineChart:function(e,t){i=this;nv.addGraph(function(){var n=nv.models.lineChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);e.datum(t.data).transition().duration(500).call(n);i.util.applyBindEvent(e,t,n,i.$el);i.util.removeLegendStyleAttr(e);return n})},pieChart:function(e,t){i=this;var n=500,r=500;nv.addGraph(function(){var s=nv.models.pieChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);e.datum([t.data]).transition().duration(1200).attr("width",n).attr("height",r).call(s);$.each(e.selectAll(".nv-slice > .nv-label > text")[0],function(e,t){$(t).removeAttr("style")});i.util.applyBindEvent(e,t,s,i.$el);i.util.removeLegendStyleAttr(e);return s})},horizontalBarChart:function(e,t){var n=nv.models.multiBarHorizontalChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);n.stacked(t.control.active!=="grouped");n.yAxis.tickFormat(d3.format(".0f"));e.datum(t.data).transition().duration(500).each("end",function(){$(e).trigger("shown")}).call(n);return n},linePlusBarChart:function(e,t){i=this;var n=[{key:"Quantity",bar:!0,values:[[11360052e5,1271e3],[11386836e5,1271e3],[11411028e5,1271e3],[11437812e5,0],[11463696e5,310],[1149048e6,123410],[115164e7,53340],[11543184e5,4320],[11569968e5,0],[11595888e5,3899486],[11622708e5,3899486],[11648628e5,3899486],[11675412e5,3564700],[11702196e5,3564700],[11726388e5,3564700],[11753136e5,2648493],[11779056e5,2648493],[1180584e6,2648493],[1183176e6,2522993],[11858544e5,2522993]]},{key:"Price",values:[[11360052e5,71.89],[11386836e5,75.51],[11411028e5,68.49],[11437812e5,62.72],[11463696e5,70.39],[1149048e6,59.77],[115164e7,57.27],[11543184e5,67.96],[11569968e5,67.85],[11595888e5,76.98],[11622708e5,81.08],[11648628e5,91.66],[11675412e5,84.84],[11702196e5,85.73],[11726388e5,84.61],[11753136e5,92.91],[11779056e5,99.8],[1180584e6,121.191],[1183176e6,122.04],[11858544e5,131.76],[11885328e5,138.48],[11911248e5,153.47],[11938032e5,189.95],[11963988e5,182.22],[11990772e5,198.08]]}];nv.addGraph(function(){var t=nv.models.linePlusBarChart().x(function(e,t){return t}).y(function(e){return e[1]}).color(d3.scale.category10().range());t.xAxis.showMaxMin(!1).tickFormat(function(e){var t=n[0].values[e]&&n[0].values[e][0]||0;return d3.time.format("%x")(new Date(t))});t.y1Axis.tickFormat(d3.format(",f"));t.y2Axis.tickFormat(function(e){return"$"+d3.format(",f")(e)});t.bars.forceY([0]);e.select("svg").length>0&&e.select("svg")[0][0]===null?e=e.append("svg:svg"):e=e.select("svg");return t})},lineFocusChart:function(e,t){function n(){return r(3,10+Math.random()*200,.1).map(function(e,t){return{key:"Stream"+t,values:e}})}function r(e,t,n){function r(e){var n=1/(.1+Math.random()),r=2*Math.random()-.5,i=10/(.1+Math.random());for(var s=0;s<t;s++){var o=(s/t-r)*i;e[s]+=n*Math.exp(-o*o)}}arguments.length<3&&(n=0);return d3.range(e).map(function(){var e=[],i;for(i=0;i<t;i++)e[i]=n+n*Math.random();for(i=0;i<5;i++)r(e);return e.map(o)})}function s(e,t){return d3.range(e).map(function(e){return d3.range(t).map(function(n){var r=20*n/t-e/3;return 2*r*Math.exp(-0.5*r)}).map(o)})}function o(e,t){return{x:t,y:Math.max(0,e)}}i=this;nv.addGraph(function(){var t=nv.models.lineWithFocusChart();t.xAxis.tickFormat(d3.format(",f"));t.yAxis.tickFormat(d3.format(",.2f"));t.y2Axis.tickFormat(d3.format(",.2f"));e=i.util.getTarget(e);e.datum(n()).transition().duration(500).call(t);return t})},util:{customControl:function(e,t){e.selectAll(".nv-controlsWrap .nv-series").each(function(e,n){var r=d3.select(this);n===0?r.attr("data-control","grouped").select("text").text(t.control.groupedName):r.attr("data-control","stacked").select("text").text(t.control.stackedName)})},getTarget:function(e){e.select("svg").length>0&&e.select("svg")[0][0]===null?e=e.append("svg:svg"):e=e.select("svg");return e},applyBindEvent:function(e,t,n,r){var i=this;e.selectAll(".nv-legend .nv-series").each(function(){$(this).off("click.cs-chart").on("click.cs-chart",function(){i.customControl(e,t);i.removeLegendStyleAttr(e)})});!t.autoResize||nv.utils.windowResize(function(){n.update();i.customControl(e,t);i.removeLegendStyleAttr(e)})},removeLegendStyleAttr:function(e){$(e.selectAll(".nv-group rect")).each(function(){$(this).removeAttr("style")});$(e.selectAll(".nv-line .nv-group")).each(function(){$(this).removeAttr("style")});var t=e.selectAll(".nv-legendWrap circle");t.length&&$(t).each(function(){$(this).removeAttr("style")})}}};$.fn.featuredChart=function(e){e=$.extend(!0,n,e);return this.each(function(){var n=$(this),r=n.data(t);if(typeof e=="string")r[e](r.options);else if(typeof e=="object"&&typeof r=="object")r.render(e);else{r=new s(this,e);n.data(t,r)}})};$.fn.featuredChart.Constructor=s;e.Cornerstone=e.Cornerstone||{};e.Cornerstone.widget=e.Cornerstone.widget||{};e.Cornerstone.widget.activeDataApi=function(e){e=e&&e.length?e.find("[data-featured=chart]"):$("[data-featured=chart]");e.each(function(){var e=this,n=$(this).data("chartBind");n&&$.getJSON(n).success(function(n){$(e)[t]({chartType:$(e).data("chartType"),data:n})})})};$(function(){e.Cornerstone.widget.activeDataApi()});if(typeof e.define=="function"&&e.define.amd&&typeof e.Cornerstone=="object"){var o=e.define;o(["jquery","underscore","backbone"],function(e,t,n){return n.View.extend({model:new n.Model,initialize:function(){t.bindAll(this,"render")},updateChart:function(t){t.model.clear();t.model.fetch({success:function(n){var r=[];e.each(n.toJSON(),function(e,t){r.push(t)});t.options.chartOptions=e.extend({},t.options.chartOptions,{data:r});t.$el.featuredChart(t.options.chartOptions)}})},render:function(){this.updateChart(this);return this}})})}}).call(this);