/*
 *  Project: SKT HTML5 Framework
 *  CodeName : CornerStone
 *  FileName : featured-chart.js
 *  Description: D3 chart를 jQuery 플러그인 형태로 사용 할 수 있고, 반응형 웹에 맞는 화면을 보여주도록 구현함.
 *  Author: 김우섭
 *  License :
 */(function(){"use strict";var e,t=this,n="featuredChart",r="ontouchstart"in window,i={shown:"shown.cs.chart",animationEnd:"animationEnd.cs.chart",complete:"shown.cs.chart"},s=!0,o=function(e,t){this.el=e;this.$el=$(e);this.options=t;nv.dev=!1;this.render(t)};o.prototype={afterRender:function(e,t,n){this.$el.data("currentChart",n);this.$el.data("currentChartControlsData",t.controlsData);var r=e.select(".nv-controlsWrap");r.attr("transform","translate(-55,"+this.util.getTranslateJson(r).y+")");this.util.removeClip(e);this.util.applyBindEvent(e,t,n,this)},render:function(t){!navigator.userAgent.toLowerCase().match(/webkit/gi)&&t.chartType.match(/.*bar3d.*/gi)&&(t.chartType=t.chartType.replace("3d",""));var n=this,r=this.util.getTarget(d3.select(this.el),t);r.$parent=this.$el;t.chartType.match(/.*bar3d.*/gi)?n[t.chartType+"Chart"](r,t):nv.addGraph(function(t,n,r){var o=r.color.length;e=t[r.chartType+"Chart"](n,r);e.tooltips(r.tooltips).color(function(e,t){return r.color[t%o]});"line"===r.chartType&&s&&console.log(r);t.util.activeAxisLabel(n,r,e);var u=r.beforeRender(n,r,e);e=typeof u=="function"?u:e;n.attr("width",r.width).attr("height",r.height).datum(r.data).transition().duration(500).each("end",function(){$(t.el).trigger(i.shown);s&&s&&console.log(i.shown);if(r.chartType.match(/line/gi)||!r.chartType.match(/bar.*|horizontalBar.*/gi)){$(t.el).trigger(i.complete);s&&s&&console.log(i.complete)}}).call(e);typeof e.afterRender=="function"&&e.afterRender("render");e.multibar&&e.multibar.dispatch.on("animated",function(e){$(t.el).trigger(i.animationEnd,{target:e.target,data:e.data});s&&console.log(i.animationEnd)});e.multibar&&e.multibar.dispatch.on("lastAnimated",function(){$(t.el).trigger(i.complete);s&&console.log(i.complete);n.$parent.hasClass("overlay")&&n.$parent.removeClass("overlay")});t.afterRender(n,r,e)}(n,r,t));return this},barChart:function(t,n){var r=this;e=nv.models.multiBarChart();e.showLegend(n.showLegend).showControls(n.showControls).controlsData(n.controlsData);e.afterRender=function(e){var i=this;if(!n.showValues)return!1;t.select(".nv-showValuesWrap").remove();if(i.multibar&&i.multibar.stacked()){t.select(".nv-showValuesWrap").remove();$(r.el).off("animationEnd._barChart");return!1}var s=t.select(".nv-barsWrap .nv-groups"),o=s.append("svg:g").attr("class","nv-showValuesWrap");o.style({opacity:1});var u=function(e,t){var r=d3.select(t.target),i=o.append("svg:text").attr("class","nv-value"),s=parseInt(r.attr("x"))+parseInt(r.attr("width"))/2,u=r.attr("y")-2,a=r.attr("width"),f=r.attr("height");i.attr("x")!=s||i.attr("y")!=u||i.attr("width")!=a||i.attr("height")!=f?i.attr({opacity:0,x:s,y:u,width:a,height:f,"text-anchor":"middle",transform:r.attr("transform")}).transition().attr({opacity:1}).text(d3.format(n.format)(r.data()[0].y)):i.attr({opacity:1});return e};r.util.removeClip(t);$(r.el).off("animationEnd._barChart").on("animationEnd._barChart",u);return e};return e},stackedBarChart:function(e,t){t.controlsData.active="stacked";var n=this.barChart(e,t);n.showControls(!1);n.stacked(!0);return n},groupedBarChart:function(e,t){t.controlsData.active="grouped";var n=this.barChart(e,t);n.showControls(!1);return n},lineChart:function(t,n){e=nv.models.lineChart().showLegend(n.showLegend);return e},pieChart:function(t,n){e=nv.models.pieChart().showLegend(n.showLegend).tooltips(n.tooltips);return e},horizontalBarChart:function(t,n){e=nv.models.multiBarHorizontalChart().showValues(n.showValues).showLegend(n.showLegend).showControls(n.showControls).valueFormat(d3.format(n.format)).tooltips(n.tooltips).controlsData(n.controlsData);return e},stackedHorizontalBarChart:function(e,t){t.controlsData.active="stacked";var n=this.horizontalBarChart(e,t);n.showControls(!1);n.stacked(!0);return n},groupedHorizontalBarChart:function(e,t){t.controlsData.active="grouped";var n=this.horizontalBarChart(e,t);n.showControls(!1);return n},linePlusBarChart:function(t,n){e=nv.models.linePlusBarChart();e.bars.forceY([0]);e.showLegend(n.showLegend);e.xAxis.showMaxMin(n.showMaxMin).tickFormat(d3.format(n.format));e.y1Axis.tickFormat(d3.format(n.format));e.y2Axis.tickFormat(d3.format(n.format));return e},lineFocusChart:function(t,n){var r=this;e=nv.models.lineWithFocusChart();e.xAxis.tickFormat(d3.format(n.format));e.yAxis.tickFormat(d3.format(n.format));e.y2Axis.tickFormat(d3.format(n.format));e.showLegend(n.showLegend);e.afterRender=function(){function i(r){r=r?r:e.x2Axis.scale().domain();var i=d3.svg.brush(),s=e.lines;if(Math.abs(r[0]-r[1])<=1)return r;e.dispatch.brush({extent:r,brush:i});var o=t.select(".nv-focus .nv-linesWrap").datum(n.data.filter(function(e){return!e.disabled}).map(function(e){return{key:e.key,values:e.values.filter(function(e,t){return s.x()(e,t)>=r[0]&&s.x()(e,t)<=r[1]})}}));o.transition().call(s);t.select(".nv-focus .nv-x.nv-axis").transition().call(e.xAxis);t.select(".nv-focus .nv-y.nv-axis").transition().call(e.yAxis);return r}t.$parent.swipe();var s=e.x2Axis.scale().domain(),o=s[1]*.1,u=[s[0],s[0]+o],a=function(e,t){var n,r,a=t.direction;if(!a.match(/left|right/gi))return!1;if("left"===a){n=u[1];r=u[1]+o}else if("right"===a){n=u[0]-o;r=u[0]}n=s[0]>=n?s[0]:n;r=s[1]<=r?s[1]:r;r=n>r?n+o:r;u=[n,r];u=i(u);typeof u=="undefined"&&(u=a==="left"?[s[1]-o,s[1]]:[s[0],s[0]+o]);e.preventDefault();e.stopPropagation();return u};t.$parent.off("swipe._chart").on("swipe._chart",a);r.util.removeClip(t)};return e},bar3dChart:function(e,t){function H(e,t){if(t<e.length){$(e[t].bar).css({height:e[t].height,"-webkit-transition":"all 0.8s ease-out"});d=setTimeout(function(){t++;H(e,t);$(n.el).trigger(i.animationEnd);s&&s&&console.log(i.animationEnd);if(e.length===t){$(n.el).trigger(i.complete);s&&s&&console.log(i.complete)}},100)}}function B(){s&&s&&console.log(i.shown);n.util.applyBindEvent3dChart(e,t);$.each(r,function(e){$(r[e].bar).stop().css({height:0,"-webkit-transition":"none"})});m="rotateX("+w+"deg) rotateY("+E+"deg)";c.css({"-webkit-transition":"none","-webkit-transform":m});clearTimeout(d);clearTimeout(v);v=setTimeout(function(){m="rotateX("+S+"deg) rotateY("+x+"deg)";c.css({"-webkit-transform":m,"-webkit-transition":"all 2.8s ease-out"});H(r,0)},100)}var n=this,r=[],o=$('<div class="figure"></div>'),u=$('<div class="graph"></div>'),a=$('<div class="bars"></div>'),f=$(t.data),l=f.length,c=e,h,p,d,v,m,g=!0,y=0,b=0,w=15,E=25,S=-20,x=$.isNumeric(t.endYRotation)?t.endYRotation:-15,T=45,N=52,C=N*l,k={chartData:function(){var e=[];f.each(function(){$(this.values).each(function(){e.push(d3.format(t.format)(this.y))})});return e},chartLegend:function(){var e=[];f.each(function(){e.push(this.key)});return e},chartYMax:function(){var e=Math.max.apply(Math,this.chartData()),t=Math.pow(10,e.toString().replace(/\..*/gi,"").length-1);return Math.ceil(Math.max.apply(Math,this.chartData())/t)*t},yLegend:function(){var e=this.chartYMax(),n=[],r=5;for(var i=0;i<r;i++)n.unshift(d3.format(t.format)(e*i/(r-1)));return n},xLegend:function(){var e=[],n=0;f.each(function(){var r=this.values,i=this.values.length;n<i&&$(this.values).each(function(){e.push(d3.format(t.format)(this.x))});n=i});return e},columnGroups:function(){var e=[];f.each(function(n){e[n]=$.map(this.values,function(e){return d3.format(t.format)(e.y)})});e=n.util.transpose(e);return e}};h=k.chartYMax();p=k.columnGroups();$.each(p,function(e){var t=$('<div class="bar-group"></div>').css({width:C});for(var n=0,i=p[e].length;n<i;n++){var s={};s.label=this[n];s.height=Math.floor(s.label/h*100)+"%";s.bar=$('<div class="bar fig'+n+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div><span>'+s.label+"</span></div>").css({left:N*n+"px"}).appendTo(t);r.push(s)}t.appendTo(a)});if(t.showLegend){var L=k.chartLegend(),A=$('<ul class="legend"></ul>');$.each(L,function(e){$('<li><span class="icon fig'+e+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div></span>'+this+"</li>").appendTo(A)});A.appendTo(o)}var O=k.xLegend(),M=O.length*C+O.length*30,_=$('<ul class="x-axis"></ul>').css({width:M});$.each(O,function(){$("<li><span>"+this+"</span></li>").css({width:C}).appendTo(_)});_.appendTo(u);var D=k.yLegend(),P=$('<ul class="y-axis"></ul>').css({width:M});$.each(D,function(){$("<li><span>"+this+"</span></li>").appendTo(P)});P.appendTo(u);a.css({width:M}).appendTo(u);e.css({width:M});e.$parent.css({width:M});u.appendTo(o);o.appendTo(c);$(document).keydown(function(){if(g){switch(event.keyCode){case 37:"bar3d"===t.chartType?b-=T:y-=T;break;case 38:"bar3d"===t.chartType?y+=T:b-=T;break;case 39:"bar3d"===t.chartType?b+=T:y+=T;break;case 40:"bar3d"===t.chartType?y-=T:b+=T}m="rotateX("+y+"deg) rotateY("+b+"deg)";c.css("-webkit-transform",m)}});$(n.el).trigger(i.shown);B();if(typeof $.fn.swipe=="function"){e.$parent.swipe();var j=function(e,n){switch(n.direction){case"left":"bar3d"===t.chartType?b-=T:y-=T;break;case"up":"bar3d"===t.chartType?y+=T:b-=T;break;case"right":"bar3d"===t.chartType?b+=T:y+=T;break;case"down":"bar3d"===t.chartType?y-=T:b+=T}m="rotateX("+y+"deg) rotateY("+b+"deg)";c.css("-webkit-transform",m);e.preventDefault();e.stopPropagation()};e.$parent.off("swipe._chart").on("swipe._chart",j)}typeof $.fn.doubletap=="function"&&e.$parent.doubletap(function(){B()})},horizontalBar3dChart:function(e,t){var n=e.closest(".widget-chart3d");!n.hasClass("widget-chart3d-hbar")&&n.addClass("widget-chart3d-hbar");t.endYRotation=0;this.bar3dChart(e,t)},util:{transpose:function(e){var t=e.length?e.length:0,n=e[0]instanceof Array?e[0].length:0;if(n===0||t===0)return[];var r,i,s=[];for(r=0;r<n;r++){s[r]=[];for(i=0;i<t;i++)s[r][i]=e[i][r]}return s},removeClip:function(e){var t=e.selectAll(".nv-groups");$(t[0]).each(function(){$(this).parent().removeAttr("clip-path")})},getTranslateJson:function(e){try{return JSON.parse(e.attr("transform").replace("translate(",'{"x":').replace(",",',"y":').replace(")","}"))}catch(t){return{x:0,y:0}}},getTarget:function(e,t){var n;if(t.chartType.match(/bar3d.*/gi)){$(e[0][0]).find(".bar3d").length===0&&$(e[0][0]).html($("<div/>",{"class":"wrapper"}).html($("<div/>",{"class":"bar3d"})));e=$(e[0][0]).find(".bar3d");!e.hasClass("chart")&&e.addClass("chart");n=e.closest(".widget-chart");!n.hasClass("widget-chart3d")&&n.addClass("widget-chart3d")}else e.select("svg").length>0&&e.select("svg")[0][0]===null?e=e.append("svg:svg"):e=e.select("svg");return e},activeAxisLabel:function(e,t,n){var r=0,i=0;if("bar"===t.chartType){n.xAxis.tickFormat(d3.format(t.format)).axisLabel(t.xAxisLabel);n.yAxis.tickFormat(d3.format(t.format)).axisLabel(t.yAxisLabel);r=$.trim(t.yAxisLabel).length>0?75:50;n.margin({top:30,right:10,bottom:50,left:r})}else if("horizontalBar"===t.chartType){n.xAxis.tickFormat(d3.format(t.format)).axisLabel(t.yAxisLabel);n.yAxis.tickFormat(d3.format(t.format)).axisLabel(t.xAxisLabel);r=$.trim(t.yAxisLabel).length>0?75:50;n.margin({top:30,right:10,bottom:50,left:r})}else if("linePlusBar"===t.chartType){n.xAxis.tickFormat(d3.format(t.format)).axisLabel(t.xAxisLabel);n.y1Axis.tickFormat(d3.format(t.format)).axisLabel(t.yAxisLabel);n.y2Axis.tickFormat(d3.format(t.format)).axisLabel(t.y2AxisLabel);r=$.trim(t.yAxisLabel).length>0?75:35;i=$.trim(t.y2AxisLabel).length>0?85:50;n.margin({top:30,right:i,bottom:50,left:r})}else if("lineFocus"===t.chartType||"line"===t.chartType){n.xAxis.tickFormat(d3.format(t.format)).axisLabel(t.xAxisLabel);n.yAxis.tickFormat(d3.format(t.format)).axisLabel(t.yAxisLabel);r=$.trim(t.yAxisLabel).length>0?75:50;n.margin({top:30,right:30,bottom:50,left:r})}else if("pie"!==t.chartType){n.xAxis.tickFormat(d3.format(t.format)).axisLabel(t.xAxisLabel);n.yAxis.tickFormat(d3.format(t.format)).axisLabel(t.yAxisLabel)}},applyBindEvent:function(e,t,n,i){var o=function(r){s&&console.log("상태:",JSON.stringify(r));!e.$parent.hasClass("overlay")&&e.$parent.addClass("overlay");setTimeout(function(){typeof n.afterRender=="function"&&n.afterRender("stateChange");typeof n.multibar!="function"&&e.$parent.hasClass("overlay")&&e.$parent.removeClass("overlay");i.afterRender(e,t,n)},10)},u=function(r){n.update();setTimeout(function(){typeof n.afterRender=="function"&&n.afterRender("resize");i.afterRender(e,t,n)},10);r.preventDefault();r.stopPropagation()};n.dispatch.stateChange&&n.dispatch.on("stateChange",o);r?window.onorientationchange=function(e){!t.autoResize||u(e)}:$(window).on("resizeEnd._chart",function(e){!t.autoResize||u(e)});$(window).on("resize._chart",function(e){e.target.resizeTO&&clearTimeout(e.target.resizeTO);e.target.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},500)})},applyBindEvent3dChart:function(e,t){var n=function(){var n=e.closest(".widget-chart3d"),r;"bar3d"===t.chartType?r=window.innerWidth/e.width():r=window.innerWidth/(e.height()+e.find(".x-axis").height());n.removeAttr("style");r=r>1?e.$parent.parent().width()/e.width():r;n.find(".wrapper").css({webkitPerspective:e.width()*20});r<1?"bar3d"===t.chartType?n.css({width:e.width(),height:e.height()+e.find(".x-axis").height(),marginLeft:-e.width()*.1*r*1.2,marginBottom:-e.height()*(1-r)*1.2,webkitTransform:"scale("+r+")"}):n.css({width:e.height()*1.1,height:e.width(),marginBottom:-e.width()*(1-r),webkitTransform:"scale("+r+")"}):"bar3d"===t.chartType?n.css({height:e.height()+e.find(".x-axis").height(),marginLeft:-e.width()*.1}):n.css({height:e.width()+e.find(".x-axis").height()})};n();r?window.onorientationchange=function(){!t.autoResize||n()}:$(window).on("resizeEnd._chart",function(){!t.autoResize||n()});$(window).on("resize._chart",function(e){e.target.resizeTO&&clearTimeout(e.target.resizeTO);e.target.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},500)})}}};$.fn.featuredChart=function(e){var t={chartType:"bar",xAxisLabel:"",yAxisLabel:"",y2AxisLabel:"",format:".0f",data:[],showMaxMin:!0,showValues:!0,showControls:!0,showLegend:!0,tooltips:!0,color:["#2c3e50","#e74c3c","#3498db","#f5a503","#7c569f","#75483e","#bf64a3","#6b6b6b"],controlsData:{active:"grouped",groupedName:"그룹",stackedName:"스택"},autoResize:!0,beforeRender:function(e,t,n){return n}};return this.each(function(){var r=$(this),i=r.data(n);if(!i){e=$.extend(!0,t,e);e.data.length||s&&console.log("데이터가 없습니다");i=new o(this,e);r.data(n,i)}else{e=$.extend(!0,t,e);r.html("");i.options=e;i.render(i.options)}})};$.fn.featuredChart.Constructor=o;t.Cornerstone=t.Cornerstone||{};t.Cornerstone.widget=t.Cornerstone.widget||{};t.Cornerstone.widget.activeDataApi=function(e){e=e&&e.length?e.find("[data-featured=chart]"):$("[data-featured=chart]");e.each(function(){var e=this,t=$(this).data("chartBind");t&&$.getJSON(t).success(function(t){$(e)[n]({chartType:$(e).data("chartType"),format:$(e).data("chartFormat"),data:t})})})};$(function(){t.Cornerstone.widget.activeDataApi()});if(typeof t.define=="function"&&t.define.amd){var u=t.define;u(["jquery","underscore","backbone","d3","nv","widget-touch"],function(e,t,n){return n.View.extend({model:new n.Model,initialize:function(){this.model.on("change",this.render,this)},render:function(){var t=[];e.each(this.model.toJSON(),function(e,n){t.push(n)});this.options.chartOptions.data=t;this.$el.featuredChart(this.options.chartOptions);return this}})})}}).call(this);