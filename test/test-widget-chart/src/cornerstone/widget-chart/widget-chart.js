/*
 *  Project: SKT HTML5 Framework
 *  CodeName : CornerStone
 *  FileName : featured-chart.js
 *  Description: D3 chart를 jQuery 플러그인 형태로 사용 할 수 있고, 반응형 웹에 맞는 화면을 보여주도록 구현함.
 *  Author: 김우섭
 *  License :
 */(function(){"use strict";var e=this,t="featuredChart",n="ontouchstart"in window,r=!0,i,s,o=function(e,t){this.el=e;this.$el=$(e);this.options=t;nv.dev=!1;this.render(t)};o.prototype={afterRender:function(e,t,n){this.$el.data("currentChart",n);this.$el.data("currentChartControl",t.control);var r=e.select(".nv-controlsWrap");r.attr("transform","translate(-55,"+this.util.getTranslateJson(r).y+")");this.util.removeClip(e);this.util.applyBindEvent(e,t,n,this)},render:function(e){!navigator.userAgent.toLowerCase().match(/webkit/gi)&&e.chartType.match(/.*bar3d.*/gi)&&(e.chartType=e.chartType.replace("3d",""));var t=this,n=this.util.getTarget(d3.select(this.el),e);n.$parent=this.$el;e.chartType.match(/.*bar3d.*/gi)?t[e.chartType+"Chart"](n,e):nv.addGraph(function(e,t,n){var s=n.color.length;i=e[n.chartType+"Chart"](t,n);i.tooltips(n.tooltips).color(function(e,t){return n.color[t%s]});"line"===n.chartType&&r&&console.log(n);if("pie"!==n.chartType)if("linePlusBar"===n.chartType){i.xAxis.showMaxMin(n.showMaxMin).tickFormat(d3.format(n.format));i.y1Axis.tickFormat(d3.format(n.format));i.y2Axis.tickFormat(d3.format(n.format))}else{i.xAxis.tickFormat(d3.format(n.format)).axisLabel(n.xAxisLabel);i.yAxis.tickFormat(d3.format(n.format)).axisLabel(n.yAxisLabel)}var o=n.beforeRender(t,n,i);i=typeof o=="function"?o:i;t.attr("width",n.width).attr("height",n.height).datum(n.data).transition().duration(500).each("end",function(){$(e.el).trigger("shown");r&&r&&console.log("shown")}).call(i);typeof i.afterRender=="function"&&i.afterRender("render");i.multibar&&i.multibar.dispatch.on("animated",function(t){$(e.el).trigger("animationEnd",t)});i.multibar&&i.multibar.dispatch.on("lastAnimated",function(n){$(e.el).trigger("complete",n);r&&console.log("complete",n);t.$parent.hasClass("overlay")&&t.$parent.removeClass("overlay")});e.afterRender(t,n,i)}(t,n,e));return this},barChart:function(e,t){var n=this;i=nv.models.multiBarChart();i.showLegend(t.showLegend).showControls(t.showControls).controlsData(t.controlsData);i.afterRender=function(r){var i=this;if(!t.showValues)return!1;e.select(".nv-showValuesWrap").remove();if(i.multibar&&i.multibar.stacked()){e.select(".nv-showValuesWrap").remove();$(n.el).off("animationEnd._barChart");return!1}var s=e.select(".nv-barsWrap .nv-groups"),o=s.append("svg:g").attr("class","nv-showValuesWrap");o.style({opacity:1});var u=function(e,n){var r=d3.select(n.target),i=o.append("svg:text").attr("class","nv-value"),s=parseInt(r.attr("x"))+parseInt(r.attr("width"))/2,u=r.attr("y")-2,a=r.attr("width"),f=r.attr("height");i.attr("x")!=s||i.attr("y")!=u||i.attr("width")!=a||i.attr("height")!=f?i.attr({opacity:0,x:s,y:u,width:a,height:f,"text-anchor":"middle",transform:r.attr("transform")}).transition().attr({opacity:1}).text(d3.format(t.format)(r.data()[0].y)):i.attr({opacity:1});return e};n.util.removeClip(e);$(n.el).off("animationEnd._barChart").on("animationEnd._barChart",u);return r};return i},stackedBarChart:function(e,t){s=this;nv.addGraph(function(){i=nv.models.multiBarChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);i.stacked(!0);e.datum(t.data).transition().duration(500).call(i);s.util.applyBindEvent(e,t,i,s);return i})},groupedBarChart:function(e,t){s=this;nv.addGraph(function(){i=nv.models.multiBarChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);i.stacked(!1);e.datum(t.data).transition().duration(500).call(i);s.util.applyBindEvent(e,t,i,s);return i})},lineChart:function(e,t){i=nv.models.lineChart().showLegend(t.showLegend);return i},pieChart:function(e,t){i=nv.models.pieChart().showLegend(t.showLegend).tooltips(t.tooltips);return i},horizontalBarChart:function(e,t){i=nv.models.multiBarHorizontalChart().showValues(t.showValues).showLegend(t.showLegend).valueFormat(d3.format(t.format)).tooltips(t.tooltips).controlsData(t.controlsData);return i},linePlusBarChart:function(){i=nv.models.linePlusBarChart();i.bars.forceY([0]);return i},lineFocusChart:function(e,t){var n=this;i=nv.models.lineWithFocusChart();i.xAxis.tickFormat(d3.format(t.format));i.yAxis.tickFormat(d3.format(t.format));i.y2Axis.tickFormat(d3.format(t.format));i.afterRender=function(){function r(n){n=n?n:i.x2Axis.scale().domain();var r=d3.svg.brush(),s=i.lines;if(Math.abs(n[0]-n[1])<=1)return n;i.dispatch.brush({extent:n,brush:r});var o=e.select(".nv-focus .nv-linesWrap").datum(t.data.filter(function(e){return!e.disabled}).map(function(e){return{key:e.key,values:e.values.filter(function(e,t){return s.x()(e,t)>=n[0]&&s.x()(e,t)<=n[1]})}}));o.transition().call(s);e.select(".nv-focus .nv-x.nv-axis").transition().call(i.xAxis);e.select(".nv-focus .nv-y.nv-axis").transition().call(i.yAxis);return n}e.$parent.swipe();var s=i.x2Axis.scale().domain(),o=s[1]*.1,u=[s[0],s[0]+o],a=function(e,t){var n,i,a=t.direction;if(!a.match(/left|right/gi))return!1;if("left"===a){n=u[1];i=u[1]+o}else if("right"===a){n=u[0]-o;i=u[0]}n=s[0]>=n?s[0]:n;i=s[1]<=i?s[1]:i;i=n>i?n+o:i;u=[n,i];u=r(u);typeof u=="undefined"&&(u=a==="left"?[s[1]-o,s[1]]:[s[0],s[0]+o]);e.preventDefault();e.stopPropagation();return u};e.$parent.off("swipe._chart").on("swipe._chart",a);n.util.removeClip(e)};return i},bar3dChart:function(e,t){function D(e,t){if(t<e.length){$(e[t].bar).css({height:e[t].height,"-webkit-transition":"all 0.8s ease-out"});h=setTimeout(function(){t++;D(e,t);$(n.el).trigger("animationEnd");e.length===t+1&&$(n.el).trigger("complete")},100)}}function P(){$(n.el).trigger("shown");n.util.applyBindEvent3dChart(e,t);$.each(r,function(e){$(r[e].bar).stop().css({height:0,"-webkit-transition":"none"})});d="rotateX("+y+"deg) rotateY("+b+"deg)";f.css({"-webkit-transition":"none","-webkit-transform":d});clearTimeout(h);clearTimeout(p);p=setTimeout(function(){d="rotateX("+w+"deg) rotateY("+E+"deg)";f.css({"-webkit-transform":d,"-webkit-transition":"all 2.8s ease-out"});D(r,0)},100)}var n=this,r=[],i=$('<div class="figure"></div>'),s=$('<div class="graph"></div>'),o=$('<div class="bars"></div>'),u=$(t.data),a=u.length,f=e,l,c,h,p,d,v=!0,m=0,g=0,y=15,b=25,w=-20,E=$.isNumeric(t.endYRotation)?t.endYRotation:-15,S=45,x=52,T=x*a+u[0].values.length*12,N=x*a,C={chartData:function(){var e=[];u.each(function(){$(this.values).each(function(){e.push(d3.format(t.format)(this.y))})});return e},chartLegend:function(){var e=[];u.each(function(){e.push(this.key)});return e},chartYMax:function(){return Math.ceil(Math.max.apply(Math,this.chartData())/1e3)*1e3},yLegend:function(){var e=this.chartYMax(),n=[],r=5;for(var i=0;i<r;i++)n.unshift(d3.format(t.format)(e*i/(r-1)));return n},xLegend:function(){var e=[],n=0;u.each(function(){var r=this.values,i=this.values.length;n<i&&$(this.values).each(function(){e.push(d3.format(t.format)(this.x))});n=i});return e},columnGroups:function(){var e=[];u.each(function(n){e[n]=$.map(this.values,function(e){return d3.format(t.format)(e.y)})});e=n.util.transpose(e);return e}};l=C.chartYMax();c=C.columnGroups();$.each(c,function(e){var t=$('<div class="bar-group"></div>').css({width:N});for(var n=0,i=c[e].length;n<i;n++){var s={};s.label=this[n];s.height=Math.floor(s.label/l*100)+"%";s.bar=$('<div class="bar fig'+n+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div><span>'+s.label+"</span></div>").css({left:x*n+"px"}).appendTo(t);r.push(s)}t.appendTo(o)});var k=C.chartLegend(),L=$('<ul class="legend"></ul>');$.each(k,function(e){$('<li><span class="icon fig'+e+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div></span>'+this+"</li>").appendTo(L)});L.appendTo(i);var A=C.xLegend(),O=$('<ul class="x-axis"></ul>').css({width:A.length*T});$.each(A,function(){$("<li><span>"+this+"</span></li>").css({width:N}).appendTo(O)});O.appendTo(s);var M=C.yLegend(),_=$('<ul class="y-axis"></ul>').css({width:A.length*T});$.each(M,function(){$("<li><span>"+this+"</span></li>").appendTo(_)});_.appendTo(s);o.css({width:A.length*T}).appendTo(s);e.css({width:A.length*T});e.$parent.css({width:A.length*T-100});s.appendTo(i);i.appendTo(f);$(document).keydown(function(){if(v){switch(event.keyCode){case 37:"bar3d"===t.chartType?g-=S:m-=S;break;case 38:"bar3d"===t.chartType?m+=S:g-=S;break;case 39:"bar3d"===t.chartType?g+=S:m+=S;break;case 40:"bar3d"===t.chartType?m-=S:g+=S}d="rotateX("+m+"deg) rotateY("+g+"deg)";f.css("-webkit-transform",d)}});P();if(typeof $.fn.swipe=="function"){e.$parent.swipe();var H=function(e,n){switch(n.direction){case"left":"bar3d"===t.chartType?g-=S:m-=S;break;case"up":"bar3d"===t.chartType?m+=S:g-=S;break;case"right":"bar3d"===t.chartType?g+=S:m+=S;break;case"down":"bar3d"===t.chartType?m-=S:g+=S}d="rotateX("+m+"deg) rotateY("+g+"deg)";f.css("-webkit-transform",d);e.preventDefault();e.stopPropagation()};e.$parent.off("swipe._chart").on("swipe._chart",H)}typeof $.fn.doubletap=="function"&&e.$parent.doubletap(function(){P()})},horizontalBar3dChart:function(e,t){var n=e.closest(".widget-chart3d");!n.hasClass("widget-chart3d-hbar")&&n.addClass("widget-chart3d-hbar");t.endYRotation=0;this.bar3dChart(e,t)},util:{transpose:function(e){var t=e.length?e.length:0,n=e[0]instanceof Array?e[0].length:0;if(n===0||t===0)return[];var r,i,s=[];for(r=0;r<n;r++){s[r]=[];for(i=0;i<t;i++)s[r][i]=e[i][r]}return s},removeClip:function(e){var t=e.selectAll(".nv-groups");$(t[0]).each(function(){$(this).parent().removeAttr("clip-path")})},getTranslateJson:function(e){try{return JSON.parse(e.attr("transform").replace("translate(",'{"x":').replace(",",',"y":').replace(")","}"))}catch(t){return{x:0,y:0}}},getTarget:function(e,t){var n;if(t.chartType.match(/bar3d.*/gi)){$(e[0][0]).find(".bar3d").length===0&&$(e[0][0]).html($("<div/>",{"class":"wrapper"}).html($("<div/>",{"class":"bar3d"})));e=$(e[0][0]).find(".bar3d");!e.hasClass("chart")&&e.addClass("chart");n=e.closest(".widget-chart");!n.hasClass("widget-chart3d")&&n.addClass("widget-chart3d")}else e.select("svg").length>0&&e.select("svg")[0][0]===null?e=e.append("svg:svg"):e=e.select("svg");return e},applyBindEvent:function(e,t,i,s){var o=function(n){r&&console.log("New State:",JSON.stringify(n));!e.$parent.hasClass("overlay")&&e.$parent.addClass("overlay");setTimeout(function(){typeof i.afterRender=="function"&&i.afterRender("stateChange");typeof i.multibar!="function"&&e.$parent.hasClass("overlay")&&e.$parent.removeClass("overlay");s.afterRender(e,t,i)},10)},u=function(n){console.log(n);i.update();setTimeout(function(){typeof i.afterRender=="function"&&i.afterRender("resize");s.afterRender(e,t,i)},10);n.preventDefault();n.stopPropagation()};i.dispatch.stateChange&&i.dispatch.on("stateChange",o);n?window.onorientationchange=function(e){!t.autoResize||u(e)}:$(window).off("resizeEnd._chart").on("resizeEnd._chart",function(e){!t.autoResize||u(e)});$(window).off("resize._chart").on("resize._chart",function(){this.resizeTO&&clearTimeout(this.resizeTO);this.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},500)})},applyBindEvent3dChart:function(e,t){var r=function(){var n=e.closest(".widget-chart3d"),r=window.innerWidth/e.width();r=r>1?e.$parent.parent().width()/e.width():r;if(r<1){n.css({marginBottom:-e.height()*(1-r)*1.2,webkitTransform:"scale("+r+")"});"horizontalBar3d"===t.chartType?n.find(".wrapper").css({webkitTransform:"scale(0.75) rotateZ(90deg) translateY("+e.width()*.15+"px)"}):n.find(".wrapper").css({marginLeft:-e.width()*.1});n.css({width:e.width()*.9})}else{n.removeAttr("style");n.find(".wrapper").removeAttr("style");n.css({width:e.width()})}};r();n?window.onorientationchange=function(e){!t.autoResize||r()}:$(window).off("resizeEnd._chart").on("resizeEnd._chart",function(e){!t.autoResize||r()});$(window).off("resize._chart").on("resize._chart",function(){this.resizeTO&&clearTimeout(this.resizeTO);this.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},500)})}}};$.fn.featuredChart=function(e){var n={chartType:"bar",xAxisLabel:"",yAxisLabel:"",format:".0f",data:{},showMaxMin:!0,showValues:!0,showControls:!0,showLegend:!0,tooltips:!0,color:["#2c3e50","#e74c3c","#3498db","#f5a503","#7c569f","#75483e","#bf64a3","#6b6b6b"],controlsData:{groupedName:"그룹",stackedName:"스택"},autoResize:!0,beforeRender:function(e,t,n){return n}};e=$.extend(!0,n,e);return this.each(function(){var n=$(this),r=n.data(t);if(typeof e=="string")r[e](r.options);else if(typeof e=="object"&&typeof r=="object")r.render(e);else{r=new o(this,e);n.data(t,r)}})};$.fn.featuredChart.Constructor=o;e.Cornerstone=e.Cornerstone||{};e.Cornerstone.widget=e.Cornerstone.widget||{};e.Cornerstone.widget.activeDataApi=function(e){e=e&&e.length?e.find("[data-featured=chart]"):$("[data-featured=chart]");e.each(function(){var e=this,n=$(this).data("chartBind");n&&$.getJSON(n).success(function(n){$(e)[t]({chartType:$(e).data("chartType"),format:$(e).data("chartFormat"),data:n})})})};$(function(){e.Cornerstone.widget.activeDataApi()});if(typeof e.define=="function"&&e.define.amd){var u=e.define;u(["jquery","underscore","backbone","d3","nv"],function(e,t,n){return n.View.extend({model:new n.Model,initialize:function(){t.bindAll(this,"render")},updateChart:function(t){t.model.clear();t.model.fetch({success:function(n){var r=[];e.each(n.toJSON(),function(e,t){r.push(t)});t.options.chartOptions=e.extend({},t.options.chartOptions,{data:r});t.$el.featuredChart(t.options.chartOptions)}})},render:function(){this.updateChart(this);return this}})})}}).call(this);