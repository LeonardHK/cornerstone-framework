/*
 *  Project: SKT HTML5 Framework
 *  CodeName : CornerStone
 *  FileName : featured-chart.js
 *  Description: D3 chart를 jQuery 플러그인 형태로 사용 할 수 있고, 반응형 웹에 맞는 화면을 보여주도록 구현함.
 *  Author: 김우섭
 *  License :
 */(function(){"use strict";var e=this,t="featuredChart",n=!0,r,i,s=function(e,t){this.el=e;this.$el=$(e);this.options=t;nv.dev=!1;this.render(t)};s.prototype={afterRender:function(e,t,n){this.$el.data("currentChart",n);this.$el.data("currentChartControl",t.control);this.util.applyBindEvent(e,t,n,this.$el)},render:function(e){var t=this,i=this.util.getTarget(d3.select(this.el),e);i.$parent=this.$el;e.chartType.match(/.*bar3d.*/gi)?t[e.chartType+"Chart"](i,e):nv.addGraph(function(e,t,i){var s=i.color.length;r=e[i.chartType+"Chart"](t,i);r.tooltips(i.tooltips).color(function(e,t){return i.color[t%s]});"line"===i.chartType&&n&&console.log(i);if("pie"!==i.chartType)if("linePlusBar"===i.chartType){r.xAxis.showMaxMin(i.showMaxMin).tickFormat(d3.format(i.format));r.y1Axis.tickFormat(d3.format(i.format));r.y2Axis.tickFormat(d3.format(i.format))}else{r.xAxis.tickFormat(d3.format(i.format)).axisLabel(i.xAxisLabel);r.yAxis.tickFormat(d3.format(i.format)).axisLabel(i.yAxisLabel)}r=i.beforeRender(t,i,r);t.attr("width",i.width).attr("height",i.height).datum(i.data).transition().duration(500).each("end",function(){$(e.el).trigger("shown");n&&n&&console.log("shown")}).call(r);typeof r.afterRender=="function"&&r.afterRender("render");r.multibar&&r.multibar.dispatch.on("animated",function(t){$(e.el).trigger("animationEnd",t)});r.multibar&&r.multibar.dispatch.on("lastAnimated",function(r){$(e.el).trigger("complete",r);n&&console.log("complete",r);t.$parent.hasClass("overlay")&&t.$parent.removeClass("overlay")});e.afterRender(t,i,r)}(t,i,e));return this},barChart:function(e,t){var n=this;r=nv.models.multiBarChart();r.showLegend(t.showLegend).showControls(t.showControls).controlsData(t.controlsData);r.afterRender=function(r){var i=this;if(!t.showValues)return!1;e.select(".nv-showValuesWrap").remove();if(i.multibar&&i.multibar.stacked()){e.select(".nv-showValuesWrap").remove();$(n.el).off("animationEnd._barChart");return!1}var s=e.select(".nv-barsWrap .nv-groups"),o=s.append("svg:g").attr("class","nv-showValuesWrap");s[0][0].parentNode.setAttribute("clip-path","");o.style({opacity:1});var u=function(e,n){var r=d3.select(n.target),i=o.append("svg:text").attr("class","nv-value"),s=parseInt(r.attr("x"))+parseInt(r.attr("width"))/2,u=r.attr("y")-2,a=r.attr("width"),f=r.attr("height");i.attr("x")!=s||i.attr("y")!=u||i.attr("width")!=a||i.attr("height")!=f?i.attr({opacity:0,x:s,y:u,width:a,height:f,"text-anchor":"middle",transform:r.attr("transform")}).transition().attr({opacity:1}).text(d3.format(t.format)(r.data()[0].y)):i.attr({opacity:1});return e};$(n.el).off("animationEnd._barChart").on("animationEnd._barChart",u);return r};return r},stackedBarChart:function(e,t){i=this;nv.addGraph(function(){r=nv.models.multiBarChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);r.stacked(!0);e.datum(t.data).transition().duration(500).call(r);i.util.applyBindEvent(e,t,r,i.$el);return r})},groupedBarChart:function(e,t){i=this;nv.addGraph(function(){r=nv.models.multiBarChart().showControls(t.showControls).showLegend(t.showLegend).tooltips(t.tooltips);r.stacked(!1);e.datum(t.data).transition().duration(500).call(r);i.util.applyBindEvent(e,t,r,i.$el);return r})},lineChart:function(e,t){r=nv.models.lineChart().showLegend(t.showLegend);return r},pieChart:function(e,t){r=nv.models.pieChart().showLegend(t.showLegend).tooltips(t.tooltips);return r},horizontalBarChart:function(e,t){r=nv.models.multiBarHorizontalChart().showValues(t.showValues).showLegend(t.showLegend).valueFormat(d3.format(t.format)).tooltips(t.tooltips).controlsData(t.controlsData);return r},linePlusBarChart:function(){r=nv.models.linePlusBarChart();r.bars.forceY([0]);return r},lineFocusChart:function(e){function t(){return n(3,10+Math.random()*200,.1).map(function(e,t){return{key:"Stream"+t,values:e}})}function n(e,t,n){function r(e){var n=1/(.1+Math.random()),r=2*Math.random()-.5,i=10/(.1+Math.random());for(var s=0;s<t;s++){var o=(s/t-r)*i;e[s]+=n*Math.exp(-o*o)}}arguments.length<3&&(n=0);return d3.range(e).map(function(){var e=[],i;for(i=0;i<t;i++)e[i]=n+n*Math.random();for(i=0;i<5;i++)r(e);return e.map(s)})}function s(e,t){return{x:t,y:Math.max(0,e)}}i=this;nv.addGraph(function(){r=nv.models.lineWithFocusChart();r.xAxis.tickFormat(d3.format(",f"));r.yAxis.tickFormat(d3.format(",.2f"));r.y2Axis.tickFormat(d3.format(",.2f"));e=i.util.getTarget(e,options);e.datum(t()).transition().duration(500).call(r);return r})},bar3dChart:function(e,t){function M(e,t){if(t<e.length){$(e[t].bar).css({height:e[t].height,"-webkit-transition":"all 0.8s ease-out"});c=setTimeout(function(){t++;M(e,t)},100)}}function _(){$.each(n,function(e){$(n[e].bar).stop().css({height:0,"-webkit-transition":"none"})});p="rotateX("+g+"deg) rotateY("+y+"deg)";u.css({"-webkit-transition":"none","-webkit-transform":p});clearTimeout(c);clearTimeout(h);h=setTimeout(function(){p="rotateX("+b+"deg) rotateY("+w+"deg)";u.css({"-webkit-transform":p,"-webkit-transition":"all 2.8s ease-out"});M(n,0)},500)}var n=[],r=$('<div id="figure"></div>'),i=$('<div class="graph"></div>'),s=$('<div class="bars"></div>'),o=$(t.data),u=e,a,f,l,c,h,p,d=!0,v=0,m=0,g=15,y=25,b=-20,w=-15,E=45,S={chartData:function(){var e=[];o.each(function(){$(this.values).each(function(){e.push(d3.format(t.format)(this.y))})});return e},chartHeading:function(){var e=t.title;return e},chartLegend:function(){var e=[];o.each(function(){e.push(this.key)});return e},chartYMax:function(){var e=this.chartData(),t=Math.ceil(Math.max.apply(Math,e)/1e3)*1e3;return t},yLegend:function(){var e=this.chartYMax(),t=[],n=5;for(var r=0;r<n;r++)t.unshift(e*r/(n-1)/1e3);console.log("yLegend",t);return t},xLegend:function(){var e=[],n=0;o.each(function(){var r=this.values,i=this.values.length;n<i&&$(this.values).each(function(){e.push(d3.format(t.format)(this.x))});n=i});return e},columnGroups:function(){var e=[];o.each(function(n){var r=this.values;e[n]=[];$(r).each(function(r){e[n].push(d3.format(t.format)(o[r].values[n].y))})});console.log("columnGroups",e);return e}};a=S.chartData();f=S.chartYMax();l=S.columnGroups();$.each(l,function(e){var t=$('<div class="bar-group"></div>');for(var r=0,i=l[e].length;r<i;r++){var o={};o.label=this[r];o.height=Math.floor(o.label/f*100)+"%";o.bar=$('<div class="bar fig'+r+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div><span>'+o.label+"</span></div>").appendTo(t);n.push(o)}t.appendTo(s)});var x=S.chartHeading(),T=$("<h4>"+x+"</h4>");T.appendTo(r);var N=S.chartLegend(),C=$('<ul class="legend"></ul>');$.each(N,function(e){var t=$('<li><span class="icon fig'+e+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div></span>'+this+"</li>").appendTo(C)});C.appendTo(r);var k=S.xLegend(),L=$('<ul class="x-axis"></ul>');$.each(k,function(e){var t=$("<li><span>"+this+"</span></li>").appendTo(L)});L.appendTo(i);var A=S.yLegend(),O=$('<ul class="y-axis"></ul>');$.each(A,function(e){var t=$("<li><span>"+this+"</span></li>").appendTo(O)});O.appendTo(i);s.appendTo(i);i.appendTo(r);r.appendTo(u);$("#reset-graph-button").click(function(){_();return!1});$("#toggle-keys-button").click(function(){if(d){d=!1;$(this).text("Keyboard OFF")}else{d=!0;$(this).text("Keyboard ON")}return!1});$(document).keydown(function(){if(d){switch(event.keyCode){case 37:m-=E;break;case 38:v+=E;break;case 39:m+=E;break;case 40:v-=E}p="rotateX("+v+"deg) rotateY("+m+"deg)";u.css("-webkit-transform",p)}});_()},util:{getTranslateJson:function(e){try{return JSON.parse(e.attr("transform").replace("translate(",'{"x":').replace(",",',"y":').replace(")","}"))}catch(t){return{x:0,y:0}}},getTarget:function(e,t){if(t.chartType.match(/bar3d.*/gi)){$(e[0][0]).find(".bar3d").length===0&&$(e[0][0]).html($("<div/>",{"class":"bar3d"}));e=$(e[0][0]).find(".bar3d")}else e.select("svg").length>0&&e.select("svg")[0][0]===null?e=e.append("svg:svg"):e=e.select("svg");return e},applyBindEvent:function(e,t,r){r.dispatch.on("stateChange",function(t){n&&console.log("New State:",JSON.stringify(t));console.log(e.$parent);!e.$parent.hasClass("overlay")&&e.$parent.addClass("overlay");setTimeout(function(){typeof r.afterRender=="function"&&r.afterRender("stateChange");typeof r.multibar!="function"&&e.$parent.hasClass("overlay")&&e.$parent.removeClass("overlay")},10)});!t.autoResize||nv.utils.windowResize(function(){r.update();setTimeout(function(){typeof r.afterRender=="function"&&r.afterRender("resize")},10)})}}};$.fn.featuredChart=function(e){var n={chartType:"bar",lineType:"basis",width:500,height:500,xAxisLabel:"X축",yAxisLabel:"Y축",format:".0f",data:{},showMaxMin:!0,showValues:!0,showControls:!0,showLegend:!0,tooltips:!0,title:"",color:["#2c3e50","#e74c3c","#3498db","#f5a503","#7c569f","#75483e","#bf64a3","#6b6b6b"],controlsData:{groupedName:"그룹",stackedName:"스택"},autoResize:!0,beforeRender:function(e,t,n){return n}};e=$.extend(!0,n,e);return this.each(function(){var n=$(this),r=n.data(t);if(typeof e=="string")r[e](r.options);else if(typeof e=="object"&&typeof r=="object")r.render(e);else{r=new s(this,e);n.data(t,r)}})};$.fn.featuredChart.Constructor=s;e.Cornerstone=e.Cornerstone||{};e.Cornerstone.widget=e.Cornerstone.widget||{};e.Cornerstone.widget.activeDataApi=function(e){e=e&&e.length?e.find("[data-featured=chart]"):$("[data-featured=chart]");e.each(function(){var e=this,n=$(this).data("chartBind");n&&$.getJSON(n).success(function(n){$(e)[t]({chartType:$(e).data("chartType"),format:$(e).data("chartFormat"),data:n})})})};$(function(){e.Cornerstone.widget.activeDataApi()});if(typeof e.define=="function"&&e.define.amd){var o=e.define;o(["jquery","underscore","backbone","d3","nv"],function(e,t,n){return n.View.extend({model:new n.Model,initialize:function(){t.bindAll(this,"render")},updateChart:function(t){t.model.clear();t.model.fetch({success:function(n){var r=[];e.each(n.toJSON(),function(e,t){r.push(t)});t.options.chartOptions=e.extend({},t.options.chartOptions,{data:r});t.$el.featuredChart(t.options.chartOptions)}})},render:function(){this.updateChart(this);return this}})})}}).call(this);